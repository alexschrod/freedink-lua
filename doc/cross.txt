Cross-compilation
=================

# Install a cross-compiler version of GCC
aptitude install mingw32


# Prepare directory to store cross-compiled libraries
mkdir -p -m 775 /usr/local/cross-tools/i386-mingw32msvc
cd /usr/local/cross-tools
ln -s i386-mingw32msvc i386-mingw32

##
# Install precompiled SDL binaries
##

VERSION=1.2.12
# Cf. http://libsdl.org/download-1.2.php
wget http://libsdl.org/release/SDL-devel-$VERSION-mingw32.tar.gz
tar xzf SDL-devel-$VERSION-mingw32.tar.gz
mv SDL-$VERSION/* i386-mingw32msvc/
rmdir SDL-$VERSION

# Install precompiled SDL_mixer binaries
VERSION=1.2.8
wget http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-$VERSION-VC8.zip
unzip SDL_mixer-devel-$VERSION-VC8.zip
cp -r SDL_mixer-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_mixer-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_mixer-$VERSION/

# Install precompiled SDL_mixer binaries
VERSION=2.0.9
wget http://libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-$VERSION-VC8.zip
unzip SDL_ttf-devel-$VERSION-VC8.zip
cp -r SDL_ttf-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_ttf-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_ttf-$VERSION/


# Cross-compile SDL_gfx (no binaries available)
cd /usr/src
VERSION=2.0.16
wget http://www.ferzkopp.net/Software/SDL_gfx-2.0/SDL_gfx-$VERSION.tar.gz
tar xzf SDL_gfx-$VERSION.tar.gz
cd SDL_gfx-$VERSION
# Refresh and mark as DLL-compliant (patch sent)
rm -f acinclude.m4
sed -i -e 's/-version-info/-no-undefined -version-info/' Makefile.am
autoreconf --force --install --symlink
export SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make
make install


##
# Cross-compile FreeDink
##
cd ~/freedink/
mkdir cross
cd cross/
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
  ../configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make clean # just in case
make
make install-strip DESTDIR=/tmp/distribute/



Alternative: cross-compile yourself
===================================

I wanted to cross-compile statically, to provide a single .exe that
includes SDL. Unfortunately GCC requires to find all symbols at
compile-time in such case, which includes all the native W32 APIs that
SDL and its libraries uses (e.g. native_midi_win32.c). Maybe this goal
is achievable with non-cross compilation.

Here are the notes anyway, this can be used to cross-compile SDL
yourself:

# SDL
VERSION=1.2.12
wget http://libsdl.org/release/SDL-$VERSION.tar.gz
tar xzf SDL-$VERSION.tar.gz
cd SDL-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu
make
make install # /usr/local/cross-tools/i386-mingw32/ by default

# SDL_mixer
VERSION=1.2.8
wget http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-$VERSION.tar.gz
cd SDL_mixer-$VERSION
# Disable MP3 support (not needed in FreeDink and avoid a dependency)
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config ./configure \
  --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --disable-music-mp3
make
make install # /usr/local/cross-tools/i386-mingw32/ by default


Static build
============

- You need to add -lwinmm

i586-mingw32msvc-gcc mousetest.c \
  `/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config --cflags \
  --static-libs` -lwinmm

- I have some troubles with SDL_gfx which tries to use
  __imp__SDL_setFramerate:

$ i586-mingw32msvc-gcc  -g -O2 -static  -o freedink.exe  bgm.o dinkvar.o fastfile.o str_util.o io_util.o sfx.o gfx.o gfx_tiles.o gfx_utils.o gfx_fonts.o init.o rect.o input.o binreloc.o woeres.o freedink.o update_frame.o ../gnulib/lib/libgnu.a -lSDL_mixer -lSDL_ttf -lSDL_gfx  -L/usr/local/cross-tools/i386-mingw32/lib -lmingw32 -lSDLmain -lSDL -mwindows -lwinmm
dinkvar.o: In function `draw_sprite_game':/home/me/projets_en_cours/dinkprog/freedink/cross/src/../../src/dinkvar.c:5479: référence indéfinie vers « __imp__zoomSurface »
init.o: In function `init':/home/me/projets_en_cours/dinkprog/freedink/cross/src/../../src/init.c:120: référence indéfinie vers « __imp__SDL_initFramerate »:/home/me/projets_en_cours/dinkprog/freedink/cross/src/../../src/init.c:124: référence indéfinie vers « __imp__SDL_setFramerate »
update_frame.o: In function `updateFrame':/home/me/projets_en_cours/dinkprog/freedink/cross/src/../../src/update_frame.c:183: référence indéfinie vers « __imp__SDL_framerateDelay »

instead of _SDL_setFramerate:

$ i586-mingw32msvc-nm /usr/local/cross-tools/i386-mingw32/lib/libSDL_gfx.a | grep -i setFramerate
00000030 T _SDL_setFramerate

It's probably something to fix in the SDL_gfx build system.
